# Post-Mortem: v0.2.3

**Branch:** `bugfix/v0.2.3-fix-dependency-arrows`
**Type:** Bugfix
**Duration:** 1 day (Started: 2025-12-21, Completed: 2025-12-21)
**Outcome:** âœ… Success

---

## Summary

Fixed a critical bug where dependency arrows between tasks were not rendering in the Gantt chart. What initially appeared to be a simple string-to-array conversion revealed a deeper issue: Pandas type coercion caused task IDs and dependency IDs to have different string representations, preventing ID matching. The fix required creating a central ID normalization function that handles all data types consistently.

---

## Scope

### Planned
- [x] Fix dependency arrows not rendering
- [x] Update branch-open-protocol.md (discovered during debugging)

### Delivered
- [x] Fix dependency arrows not rendering
- [x] ID normalization helper for type consistency
- [x] Comprehensive unit tests for edge cases
- [x] Updated branch-open-protocol.md with commit requirement
- [x] Backward compatibility in sort_utils.py

### Deferred Items
None.

---

## Timeline

| Milestone | Planned | Actual | Variance |
|-----------|---------|--------|----------|
| Start | 2025-12-21 | 2025-12-21 | - |
| Initial fix (stringâ†’array) | - | 2025-12-21 | - |
| Discovery: uncommitted changes | - | 2025-12-21 | Unplanned |
| Discovery: type mismatch | - | 2025-12-21 | Unplanned |
| Final fix with normalization | - | 2025-12-21 | - |
| Testing complete | - | 2025-12-21 | - |
| Release | 2025-12-21 | 2025-12-21 | - |

---

## Commit Analysis

| Metric | Value | Assessment |
|--------|-------|------------|
| Total commits | 17 | |
| Feature commits | 0 | |
| Fix commits | 7 | |
| Debug commits | 6 | |
| Documentation commits | 3 | |
| Test commits | 1 | |
| Reverts | 0 | |
| Churn ratio | 35% (6 debug / 17 total) | ðŸŸ¡ Medium |

**Analysis:** Multiple debug iterations were necessary to diagnose the Pandas type coercion issue. All debug commits were properly cleaned up at the end.

---

## What Went Well

- **Systematic Debugging:** Used console and backend logging to trace data flow from DataFrame â†’ Python â†’ JSON â†’ JavaScript â†’ Frappe Gantt.
- **User Collaboration:** User provided crucial insight about raw dependency value being float vs expected bigint, which led to discovering the Pandas type coercion issue.
- **Comprehensive Testing:** Added 10 unit tests covering all ID normalization edge cases to prevent regression.
- **Documentation Updates:** Discovered and fixed critical gap in branch protocol (commit requirement before User QA).
- **Clean Cleanup:** All debug logging removed in final commit.

---

## What Didn't Go Well

- **Initial Spec Incomplete:** The spec assumed a simple stringâ†’array conversion but missed the deeper type mismatch issue. This was only discoverable through runtime testing.
- **Multiple QA Cycles:** Required 3 QA cycles to identify all issues:
  1. String vs array format
  2. Uncommitted changes (not loading)
  3. Type mismatch (int vs float)
- **Testing Gap:** Unit tests didn't catch the Pandas type coercion issue because test data didn't include NaN values in the dependency column.

---

## Blockers Encountered

### 1. Uncommitted Changes Not Loading
**Issue:** After initial fix, user reported arrows still not appearing. Root cause: Dataiku plugins load from committed Git code, not working directory files.

**Resolution:** Updated `branch-open-protocol.md` to require commits **before** User QA, not after. This prevents future confusion.

### 2. Pandas Type Coercion
**Issue:** ID column (no NaN) read as int64 â†’ `277` â†’ `"277"`. Dependency column (with NaN) read as float64 â†’ `276.0` â†’ `"276.0"`. IDs didn't match.

**Resolution:** Created `_normalize_id()` helper that converts whole-number floats to int representation while preserving actual decimals.

---

## Technical Discoveries

### Platform Behavior

1. **Frappe Gantt Dependency Format:** The library expects `task.dependencies` as an array of strings, not a comma-separated string. When it calls `.map()` on a string, the operation fails silently - no errors, just no arrows.

2. **Pandas Type Coercion:** When a column contains NaN values, Pandas reads it as float64 even if all non-NaN values are integers. This creates subtle type mismatches when comparing IDs from different columns.

   ```python
   # ID column (no NaN): int64
   df['id'] = [276, 277, 278]  # â†’ 277 â†’ "277"

   # Dependency column (has NaN): float64
   df['deps'] = [np.nan, 276.0, 277.0]  # â†’ 276.0 â†’ "276.0"

   # Result: "277" != "276.0" - no match!
   ```

3. **Dataiku Plugin Loading:** Plugins load code from committed Git files, not the working directory. Changes must be committed before user testing via plugin reload.

### Code Architecture

1. **Central Normalization:** Instead of normalizing IDs in multiple places, creating a single `_normalize_id()` helper ensures consistency across task IDs, dependency IDs, and dependency validation.

2. **Backward Compatibility:** When changing data formats (stringâ†’array), update all consumers and add format detection for gradual migration.

---

## CLI Docs Candidates

1. **ID Normalization for Pandas:** Document the whole-number float normalization pattern for handling Pandas type coercion.
2. **Dataiku Plugin Loading:** Already documented in updated `branch-open-protocol.md`.
3. **Frappe Gantt Dependencies:** Already documented in `cli-docs/reference/frappe-gantt.md`.

---

## Recommendations

### For Next Release

1. **Test Data Diversity:** Ensure unit tests include:
   - Columns with NaN values (triggers float64 coercion)
   - Mixed data types (int, float, string, decimal)
   - Edge cases (empty strings, whitespace, null values)

2. **Integration Tests:** Consider adding integration tests that test the full pipeline (DataFrame â†’ backend â†’ frontend) to catch type mismatches that unit tests miss.

### Lessons Learned

1. **Commits Before QA:** Always commit code before user QA testing with Dataiku plugins. This is now documented in `branch-open-protocol.md`.

2. **Type Coercion Awareness:** When working with Pandas DataFrames, be aware that:
   - NaN presence changes column dtypes
   - Float IDs need normalization to match int IDs
   - Always use consistent normalization for related fields

3. **Debug Systematically:** When facing mysterious issues:
   - Add logging at every pipeline stage
   - Trace data transformations step by step
   - Check types, not just values
   - Clean up debug code when done

4. **User Insights Are Valuable:** The user's observation about "float vs bigint" was the breakthrough that led to discovering the Pandas type coercion issue. Listen to user feedback carefully - they often see runtime behaviors that specs miss.

5. **Test What You Fix:** The fix included comprehensive unit tests to prevent regression. Every fix should include tests that would have caught the original bug.

---

## Metrics

**Code Quality:**
- Test coverage increased with 10 new test methods
- Zero linting issues introduced
- All debug code cleaned up

**User Impact:**
- High: Dependency arrows are a core feature - users couldn't visualize task relationships without this fix
- Positive user feedback: "This version is now working"

**Technical Debt:**
- Reduced: Created reusable `_normalize_id()` helper for future ID handling
- Reduced: Documented commit requirement in protocol to prevent future confusion
- None added
