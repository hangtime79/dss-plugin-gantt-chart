# Post-Mortem: v0.4.0

**Branch:** `feature/v0.4.0-view-enhancements`
**Type:** Feature
**Duration:** 2 days (Started: 2025-12-21, Completed: 2025-12-22)
**Outcome:** ‚ö†Ô∏è Partial (core features delivered, sticky header deferred)

---

## Summary

Implemented view enhancements for the Gantt chart: responsive header abbreviations, fixed date boundary controls, and header collision fixes. The sticky header feature was investigated but deferred after CSS-only approach proved ineffective due to nested scroll containers.

---

## Scope

### Planned
- [x] Fix header text collisions (CSS overflow)
- [x] Responsive header abbreviations (Week, Month, Year)
- [ ] Sticky header during vertical scroll
- [x] Date boundary controls (start/end)
- [x] Date boundary enhancements (inside constraint, validation UI)

### Delivered
- [x] Header text collision fix - CSS overflow handling
- [x] Responsive Week labels (range vs single day based on width)
- [x] Responsive Month labels (full ‚Üí 3-letter ‚Üí 1-letter)
- [x] Responsive Year labels (YYYY ‚Üí YY)
- [x] Fixed Start/End Date parameters
- [x] Date validation with error UI
- [x] Frappe clientWidth crash fix

### Deferred Items

| Item | Reason | Target Version |
|------|--------|----------------|
| Sticky header | CSS approach ineffective; nested scroll containers | v0.4.2 |
| Data population on view transitions | Separate Frappe Gantt bug | v0.4.1 |
| Today button Month View | Frappe navigation bug | v0.4.1 |
| Cursor position on mode switch | UI polish | v0.4.2 |
| Year in upper headers | Feature request | v0.4.2 |
| Month letter visibility | Feature request | v0.4.2 |
| Decade format in Year view | Feature request | v0.4.2 |

---

## Commit Analysis

| Metric | Value | Assessment |
|--------|-------|------------|
| Total commits | 6 | |
| Feature commits | 2 | |
| Fix/debug commits | 2 | |
| Docs commits | 2 | |
| Reverts | 0 | |
| Churn ratio | 33% | üü° Medium (iterative debugging expected) |

High-churn files:
- `app.js` (4 commits) - Iterating on responsive label logic
- `intervention.md` (5 commits) - Documentation updates

Churn was expected for this feature - responsive labels required testing multiple threshold values and fixing property access issues.

---

## What Went Well

- **Systematic debugging**: Used intervention log to track issues and solutions
- **Root cause analysis**: Found and fixed `options` vs `config` property confusion
- **Library patching**: Successfully patched Frappe Gantt clientWidth crash
- **Feature scope control**: Deferred sticky header rather than shipping broken feature

---

## What Didn't Go Well

- **Sticky header investigation**: Spent time on CSS approach before understanding nested scroll container issue
- **Month view DOM structure assumption**: Assumed `.upper-text` was months, but it's years in Month view
- **Initial property access bug**: Used `config.view_mode` (object) instead of `options.view_mode` (string)

---

## Blockers Encountered

| Blocker | Impact | Resolution | Time Lost |
|---------|--------|------------|-----------|
| Nested scroll containers | Sticky header doesn't work | Deferred to v0.4.2 | ~2 hours investigation |
| Frappe clientWidth undefined | Crashes on view switch | Added null guards | ~1 hour |
| Wrong property access | Labels not updating | Use `options` not `config` | ~30 min |

---

## Technical Discoveries

### Platform Behavior
- Dataiku webapp parameter handling includes built-in debouncing (blur/enter triggers)
- No custom debouncing implementation needed for text inputs

### Library Behavior (Frappe Gantt)
- `ganttInstance.options` = primitives (strings, numbers from user config)
- `ganttInstance.config` = computed objects (internal state)
- **Always use `options` for reading user-specified settings**

- Month view DOM structure is counterintuitive:
  - `.upper-text` = years (2021, 2022, etc.)
  - `.lower-text` = months (January, February, etc.)

- Frappe Gantt has no `destroy()` method - event listeners persist after DOM cleared
- `this.upperTexts` can contain stale DOM references after view mode switch

### Architecture Insights
- Post-render DOM manipulation needs `requestAnimationFrame` - DOM not ready immediately
- Labels are recreated on view change - must reapply formatting in `on_view_change` callback

---

## CLI Docs Candidates

Items added to CLAUDE.md:

1. **ganttInstance.options vs .config**: `options` = primitives, `config` = computed objects. Use `options.view_mode` for string.
2. **Month view DOM structure**: `.upper-text` = years, `.lower-text` = months (counterintuitive)
3. **Frappe Gantt no destroy()**: Event listeners persist. Guard against undefined DOM refs.
4. **frappe-gantt.umd.js is loaded**: NOT .es.js. Patch the UMD file for browser fixes.

---

## Recommendations

### For v0.4.1
- Focus on view transition data population bug (HIGH severity)
- Focus on Today button navigation in Month View

### For v0.4.2
- Implement sticky header via JavaScript scroll sync (Option B)
- Address cursor positioning on mode switch
- Implement upper element year formatting feature requests

### Process Improvements
- Read Frappe Gantt source for DOM structure before assuming element purposes
- Add intervention log gotchas to CLAUDE.md immediately upon discovery

---

## Lessons Learned

1. **Frappe Gantt property access**: Always use `options` for primitives, never `config`
2. **CSS sticky limitations**: Doesn't work when target is in nested scroll container
3. **DOM manipulation timing**: Use `requestAnimationFrame` for post-render operations
4. **Feature scope discipline**: Better to defer than ship broken features
