# Feature v0.2.0 - Custom Tooltips Specification

## Branch
`feature/v0.2.0-custom-tooltips`

## Overview
Enable users to select specific columns from their dataset (e.g., "Assignee", "Budget", "Priority") to be displayed in the task details popup. The implementation respects the order (sorting) of the columns as defined by the user in the configuration panel.

**Prerequisite:** The current popup is broken (displays "Undefined to Undefined"). This must be fixed first.

---

## Bug Fix: Popup Shows "Undefined to Undefined"

### Symptom
When clicking/hovering on a task bar, the popup displays "Undefined to Undefined" instead of the actual date range.

### Root Cause (Investigation Required)
The `buildPopupHTML(task)` function references `task.start` and `task.end`, but Frappe Gantt's popup callback may pass the task object with different property names or structure:

**Possible causes:**
1. Frappe Gantt uses `_start` and `_end` (internal properties with underscore prefix)
2. Frappe Gantt stores dates as Date objects, not strings
3. The task object in the callback has a different structure than what we send

### Investigation Steps
1. Add `console.log('Popup task object:', task)` inside `buildPopupHTML()`
2. Inspect the actual structure of the task object in browser console
3. Identify correct property names for start/end dates

### Likely Fix
Based on Frappe Gantt's typical behavior, the fix is likely one of:

```javascript
// Option A: Use underscore-prefixed internal properties
html += `<div class="popup-dates">${task._start} to ${task._end}</div>`;

// Option B: Format Date objects
const startStr = task._start instanceof Date ? task._start.toISOString().split('T')[0] : task.start;
const endStr = task._end instanceof Date ? task._end.toISOString().split('T')[0] : task.end;
html += `<div class="popup-dates">${startStr} to ${endStr}</div>`;

// Option C: Access original data
html += `<div class="popup-dates">${task.start || task._start} to ${task.end || task._end}</div>`;
```

**Note:** The implementing AI should debug this by logging the task object to console and inspecting its actual structure.

---

## Technical Approach

### Data Flow
```
webapp.json (tooltipColumns param)
        ↓
    backend.py (reads config, passes to transformer)
        ↓
    task_transformer.py (extracts values, attaches to task.custom_fields)
        ↓
    JSON response (tasks with custom_fields)
        ↓
    app.js (buildPopupHTML renders custom_fields)
```

---

## File Modifications

### 1. `webapps/gantt-chart/webapp.json`

**Purpose:** Add `tooltipColumns` parameter to allow multi-column selection.

**Location:** Add to `leftBarParams` after the "Behavior" section (after `highlightWeekends`, before "Performance").

**Code to Add:**
```json
{
    "type": "SEPARATOR",
    "label": "Tooltip Fields"
},
{
    "name": "tooltipColumns",
    "type": "DATASET_COLUMNS",
    "datasetParamName": "dataset",
    "label": "Additional Fields",
    "description": "Select columns to display in task popup. Drag to reorder.",
    "mandatory": false
}
```

**Important Notes:**
- Use `DATASET_COLUMNS` (not `COLUMNS` which is recipe-specific)
- `datasetParamName` must match the existing `dataset` parameter
- Returns an array of column names: `["Assignee", "Priority", "Budget"]`
- User can drag-and-drop to reorder in the UI

---

### 2. `webapps/gantt-chart/backend.py`

**Purpose:** Pass the `tooltipColumns` config list to the transformer.

**Location:** In the `get_tasks()` function, modify the `TaskTransformerConfig` creation (around line 90-99).

**Current Code:**
```python
transformer_config = TaskTransformerConfig(
    id_column=config.get('idColumn'),
    name_column=config.get('nameColumn'),
    start_column=config.get('startColumn'),
    end_column=config.get('endColumn'),
    progress_column=config.get('progressColumn'),
    dependencies_column=config.get('dependenciesColumn'),
    color_column=config.get('colorColumn'),
    max_tasks=int(config.get('maxTasks', 1000))
)
```

**Change - Add one line:**
```python
transformer_config = TaskTransformerConfig(
    id_column=config.get('idColumn'),
    name_column=config.get('nameColumn'),
    start_column=config.get('startColumn'),
    end_column=config.get('endColumn'),
    progress_column=config.get('progressColumn'),
    dependencies_column=config.get('dependenciesColumn'),
    color_column=config.get('colorColumn'),
    tooltip_columns=config.get('tooltipColumns'),  # ADD THIS LINE
    max_tasks=int(config.get('maxTasks', 1000))
)
```

**Important Notes:**
- `config.get('tooltipColumns')` returns `None` if not configured, or a list like `["Assignee", "Priority"]`
- No additional validation needed here - transformer handles it

---

### 3. `python-lib/ganttchart/task_transformer.py`

**Purpose:** Extract values for specified tooltip columns and pack them into task objects.

**Current State:** The transformer already has partial support for `tooltip_columns`:
- `TaskTransformerConfig.tooltip_columns` exists (line 31)
- `_validate_config` checks for missing optional columns (lines 208-209)
- `_process_row` has basic `custom_fields` handling (lines 295-312)

**Required Changes:**

#### Change: Update custom_fields to use ordered list structure

**Current Code (lines 294-312):**
```python
# Add custom tooltip fields
if self.config.tooltip_columns:
    custom_fields = {}
    # Handle case where tooltip_columns might be a single string (should be list)
    cols = self.config.tooltip_columns
    if isinstance(cols, str):
        cols = [cols]

    for col in cols:
        if col in row:
            val = row[col]
            if not pd.isna(val):
                # Format dates if needed, or convert to string
                if hasattr(val, 'strftime'):
                     custom_fields[col] = val.strftime('%Y-%m-%d')
                else:
                     custom_fields[col] = str(val)
    if custom_fields:
        task['custom_fields'] = custom_fields
```

**Updated Code:**
```python
# Add custom tooltip fields
if self.config.tooltip_columns:
    custom_fields = []  # Use list to preserve order explicitly
    cols = self.config.tooltip_columns
    if isinstance(cols, str):
        cols = [cols]

    for col in cols:
        if col in row.index:
            val = row[col]
            # Format value (handle null, dates, numbers)
            if pd.isna(val):
                formatted_val = None  # Will be handled by frontend as "-"
            elif hasattr(val, 'strftime'):
                formatted_val = val.strftime('%Y-%m-%d')
            elif isinstance(val, (int, float)):
                # Preserve numeric types for display
                if pd.isna(val):
                    formatted_val = None
                else:
                    formatted_val = val
            else:
                formatted_val = str(val).strip()

            custom_fields.append({
                'label': col,
                'value': formatted_val
            })

    if custom_fields:
        task['custom_fields'] = custom_fields
```

**Key Changes:**
1. Changed from `dict` to `list` of `{label, value}` objects
2. Use `row.index` instead of `row` for column existence check (correct for pandas Series)
3. Handle `NaN`/`None` values explicitly (set to `None` for frontend handling)
4. Preserve numeric types for potential frontend formatting

---

### 4. `webapps/gantt-chart/app.js`

**Purpose:**
1. FIX the existing popup bug (Undefined to Undefined)
2. Update `buildPopupHTML(task)` to iterate over `task.custom_fields` and render them

**Location:** `buildPopupHTML` function (lines 296-322)

**Step 1: Debug the current popup issue**

Add console.log to understand the task object structure:
```javascript
function buildPopupHTML(task) {
    console.log('Popup task object:', JSON.stringify(task, null, 2));
    // ... rest of function
}
```

**Step 2: Fix date display and add custom fields**

**Updated buildPopupHTML function:**
```javascript
function buildPopupHTML(task) {
    let html = `
        <div class="gantt-popup">
            <div class="popup-title">${escapeHtml(task.name)}</div>
    `;

    // Date range - Frappe Gantt uses _start and _end internally
    // These are Date objects, need to format them
    const formatDate = (date) => {
        if (!date) return 'N/A';
        if (date instanceof Date) {
            return date.toISOString().split('T')[0];
        }
        return String(date);
    };

    // Try _start/_end first (Frappe Gantt internal), fallback to start/end
    const startDate = task._start || task.start;
    const endDate = task._end || task.end;
    html += `<div class="popup-dates">${formatDate(startDate)} to ${formatDate(endDate)}</div>`;

    // Progress (if available)
    if (task.progress !== undefined && task.progress !== null) {
        html += `<div class="popup-progress">Progress: ${task.progress}%</div>`;
    }

    // Dependencies (if any)
    if (task.dependencies) {
        const depsList = Array.isArray(task.dependencies)
            ? task.dependencies.join(', ')
            : task.dependencies;
        if (depsList) {
            html += `<div class="popup-deps">Depends on: ${escapeHtml(depsList)}</div>`;
        }
    }

    // Custom fields (user-selected tooltip columns)
    if (task.custom_fields && Array.isArray(task.custom_fields) && task.custom_fields.length > 0) {
        html += '<div class="popup-custom-fields">';
        for (const field of task.custom_fields) {
            // Handle null/undefined values gracefully
            const displayValue = (field.value === null || field.value === undefined)
                ? '-'
                : escapeHtml(String(field.value));
            html += `<div class="popup-field"><span class="field-label">${escapeHtml(field.label)}:</span> <span class="field-value">${displayValue}</span></div>`;
        }
        html += '</div>';
    }

    html += '</div>';
    return html;
}
```

**Key Changes:**
1. Added `formatDate()` helper function to handle Date objects
2. Use `task._start` / `task._end` (Frappe Gantt's internal properties) with fallback
3. Added section for `custom_fields` after dependencies
4. Iterate through the array preserving order
5. Handle `null`/`undefined` values by displaying "-"
6. Use `escapeHtml` for both label and value (security)

---

## Optional: CSS Styling

Add to inline `<style>` in `webapps/gantt-chart/app.html`:

```css
.popup-custom-fields {
    margin-top: 8px;
    border-top: 1px solid #eee;
    padding-top: 8px;
}

.popup-field {
    font-size: 12px;
    margin: 4px 0;
}

.field-label {
    color: #666;
    font-weight: 500;
}

.field-value {
    color: #333;
}
```

---

## Data Type Handling

The transformer should handle these column types appropriately:

| Data Type | Handling | Display |
|-----------|----------|---------|
| String | Pass as-is | "John Doe" |
| Integer | Pass as number | "42" |
| Float | Pass as number | "3.14" |
| Date/DateTime | Format as YYYY-MM-DD | "2024-03-15" |
| Boolean | Convert to string | "True" / "False" |
| Null/NaN | Set to `null` | "-" |
| Empty string | Pass as-is | "" |

---

## Edge Cases

### 1. Column Not in Dataset
**Scenario:** User selects a column, then switches to a dataset that doesn't have it.
**Handling:** Transformer logs warning (already in `_validate_config`), column is skipped for each row.

### 2. All Values Null
**Scenario:** Selected column exists but all values are null.
**Handling:** Frontend displays "-" for each task. Consider hiding the field entirely (optional enhancement).

### 3. Long Values
**Scenario:** Column contains very long text.
**Handling:** Frontend CSS should handle with `text-overflow: ellipsis` or `max-width`.

### 4. Special Characters
**Scenario:** Values contain `<`, `>`, `&`, quotes.
**Handling:** `escapeHtml()` already used in frontend.

### 5. Unicode Characters
**Scenario:** Values contain emojis or non-ASCII characters.
**Handling:** Python `str()` and JavaScript `String()` handle UTF-8 properly.

---

## Success Criteria

| # | Criterion | Verification |
|---|-----------|--------------|
| 1 | Popup Bug Fixed | Popup displays actual dates (not "Undefined to Undefined") |
| 2 | Configuration UI | New "Tooltip Fields" picker appears in sidebar |
| 3 | Column Selection | User can select multiple columns from the dataset |
| 4 | Ordering | User can drag-and-drop columns to reorder |
| 5 | Data Flow | Selected column data is correctly passed from Python to JS |
| 6 | Popup Display | Clicking/hovering a task shows custom fields after standard info |
| 7 | Order Preserved | Order of fields in popup matches order in sidebar |
| 8 | Null Handling | Missing values displayed as "-" |
| 9 | No Regression | Existing functionality (progress, dependencies) still works |
| 10 | Empty Selection | No custom fields section if none selected |

---

## Testing Checklist

### Manual Testing
- [ ] Verify popup shows correct dates (bug fix)
- [ ] Add tooltipColumns parameter, reload plugin
- [ ] Select 2-3 columns of different types (string, number, date)
- [ ] Verify columns appear in popup in correct order
- [ ] Reorder columns in sidebar, verify popup order updates
- [ ] Test with column containing null values
- [ ] Test with column containing special characters
- [ ] Remove all tooltip columns, verify no custom_fields section
- [ ] Switch datasets, verify graceful handling of missing columns

### Unit Tests (Optional)
Add tests to `tests/python/unit/test_task_transformer.py`:
- Test `custom_fields` generation with various column types
- Test ordering preservation
- Test null/NaN handling
- Test missing column graceful handling

---

## Watch Out For

1. **Popup Bug:** Must debug actual task object structure from Frappe Gantt callback
2. **Parameter Type:** Use `DATASET_COLUMNS` (not `COLUMNS`) for webapps
3. **Data Structure:** Use array of `{label, value}` objects (not dict) to preserve order
4. **JSON Serialization:** Ensure `NaN` is converted to `null` (JSON doesn't support NaN)
5. **XSS Prevention:** Always escape user data before rendering in HTML
6. **Row Index Access:** Use `col in row.index` not `col in row` for pandas Series
7. **Date Objects:** Frappe Gantt converts date strings to Date objects internally

---

## Implementation Order

1. **app.js** - Debug and fix popup bug FIRST (add console.log, identify correct properties)
2. **webapp.json** - Add parameter (allows testing UI immediately)
3. **backend.py** - Pass tooltipColumns to transformer (one-line change)
4. **task_transformer.py** - Update custom_fields generation
5. **app.js** - Add custom_fields rendering to popup
6. **(Optional) CSS** - Add styling for custom fields

---

**Version:** 1.0
**Created:** 2025-12-20
**Author:** AI Assistant
