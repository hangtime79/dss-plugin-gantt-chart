# Intervention Log: v0.4.1 View Transition Bugfixes

**Branch:** `bugfix/v0.4.1-fix-view-transitions`
**Started:** 2025-12-22
**Status:** Implementation Complete - Awaiting QA

---

## Bugs Addressed

### Bug 1: Data Fails to Populate on View Transitions
**Severity:** HIGH

**Symptom:** When switching between specific view modes (Hour → Quarter Day, Quarter Day → Half Day, Half Day → Day), the chart renders blank or with missing bars.

**Transitions Affected:**
- Hour → Quarter Day
- Quarter Day → Half Day
- Half Day → Day

### Bug 2: Scroll/Cursor Position Jumps Incorrectly
**Severity:** MEDIUM

**Symptom:** Switching view modes leaves the chart at a random date instead of snapping to Today or the logical center date.

---

## Root Cause Analysis

### The Problem: `maintain_scroll` Flag

In `frappe-gantt.js`, the view mode dropdown event listener was calling:

```javascript
this.change_view_mode(t.value, !0); // !0 = true = maintain_scroll
```

When `maintain_scroll=true`:
1. Saves current pixel scroll position (`scrollLeft`)
2. Passes `true` to `setup_dates(true)`
3. Inside `setup_gantt_dates(true)`, date recalculation is **SKIPPED**

```javascript
// frappe-gantt.es.js
setup_gantt_dates(t) {
  // ...
  if (!t) { // Only recalculate if t is false
     // Recalculate gantt_start/end based on new unit/padding
  }
}
```

### Why This Breaks Things

**Bug 1 (Data disappears):**
By skipping date recalculation, the chart attempts to render the new view mode (e.g., "Day") using time boundaries calculated for the previous mode (e.g., "Hour"). This mismatches grid generation and bar placement logic.

**Bug 2 (Wrong scroll position):**
The code restores the **pixel** scroll position, not a logical date position.
- Example: User at pixel 1000 in "Day" view (≈1 month in)
- Switches to "Year" view
- Pixel 1000 in "Year" view = potentially 10 years in the future
- Result: User loses their place

---

## The Fix

**Simple one-line change in two files:**

Remove the `!0` (true) argument from `change_view_mode` call in the view mode select event listener.

### Before
```javascript
this.change_view_mode(t.value, !0);
```

### After
```javascript
this.change_view_mode(t.value);
```

This:
1. Allows `gantt_start` and `gantt_end` to be recalculated for the new view scale
2. Disables `maintain_scroll`, falling back to `options.scroll_to` behavior (defaults to 'today')

---

## Implementation

### Files Modified

| File | Change | Line |
|------|--------|------|
| `resource/frappe-gantt.es.js` | Remove `!0` argument | ~1077 |
| `resource/frappe-gantt.umd.js` | Remove `!0` argument | minified line |
| `plugin.json` | Version 0.4.0 → 0.4.1 | 6 |

### Commit
```
2193eab bugfix(v0.4.1): Fix view transitions and scroll position
```

---

## Feature Status

| Bug | Status | Notes |
|-----|--------|-------|
| Data fails to populate | ✅ Fixed | Removed maintain_scroll flag |
| Scroll position jumps | ✅ Fixed | Now scrolls to Today on view change |

---

## QA Checklist (Pending User Verification)

- [ ] Load chart with tasks
- [ ] Switch Week → Month: bars visible, scrolls to Today
- [ ] Switch Month → Year: bars visible, scrolls to Today
- [ ] Switch Week → Day → Half Day → Quarter Day → Hour: data visible at each step
- [ ] "Today" button works in all views

---

## Technical Discovery

**Frappe Gantt `maintain_scroll` behavior:**
- Intended for programmatic view changes where you want to preserve position
- NOT suitable for user-initiated view mode switches from dropdown
- Pixel-based scroll preservation doesn't translate between views with different column widths

**Lesson Learned:** The `maintain_scroll` parameter is a convenience feature that only works when the time scale is similar. For drastic view mode changes (Hour ↔ Year), it causes more problems than it solves.

---

## Related Documents

- Spec: `plan/specs/bugfix-v0.4.1-spec.md`
- Deferred from: v0.4.0 (see `plan/interventions/v0.4.0-intervention.md`)
