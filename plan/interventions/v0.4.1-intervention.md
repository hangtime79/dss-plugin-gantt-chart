# Intervention Log: v0.4.1 View Transition Bugfixes

**Branch:** `bugfix/v0.4.1-fix-view-transitions`
**Started:** 2025-12-22
**Status:** QA Found New Issue - SVG Width Bug Needs Fix

---

## Bugs Addressed

### Bug 1: Data Fails to Populate on View Transitions
**Severity:** HIGH

**Symptom:** When switching between specific view modes (Hour â†’ Quarter Day, Quarter Day â†’ Half Day, Half Day â†’ Day), the chart renders blank or with missing bars.

**Transitions Affected:**
- Hour â†’ Quarter Day
- Quarter Day â†’ Half Day
- Half Day â†’ Day

### Bug 2: Scroll/Cursor Position Jumps Incorrectly
**Severity:** MEDIUM

**Symptom:** Switching view modes leaves the chart at a random date instead of snapping to Today or the logical center date.

---

## Root Cause Analysis

### The Problem: `maintain_scroll` Flag

In `frappe-gantt.js`, the view mode dropdown event listener was calling:

```javascript
this.change_view_mode(t.value, !0); // !0 = true = maintain_scroll
```

When `maintain_scroll=true`:
1. Saves current pixel scroll position (`scrollLeft`)
2. Passes `true` to `setup_dates(true)`
3. Inside `setup_gantt_dates(true)`, date recalculation is **SKIPPED**

```javascript
// frappe-gantt.es.js
setup_gantt_dates(t) {
  // ...
  if (!t) { // Only recalculate if t is false
     // Recalculate gantt_start/end based on new unit/padding
  }
}
```

### Why This Breaks Things

**Bug 1 (Data disappears):**
By skipping date recalculation, the chart attempts to render the new view mode (e.g., "Day") using time boundaries calculated for the previous mode (e.g., "Hour"). This mismatches grid generation and bar placement logic.

**Bug 2 (Wrong scroll position):**
The code restores the **pixel** scroll position, not a logical date position.
- Example: User at pixel 1000 in "Day" view (â‰ˆ1 month in)
- Switches to "Year" view
- Pixel 1000 in "Year" view = potentially 10 years in the future
- Result: User loses their place

---

## The Fix

**Simple one-line change in two files:**

Remove the `!0` (true) argument from `change_view_mode` call in the view mode select event listener.

### Before
```javascript
this.change_view_mode(t.value, !0);
```

### After
```javascript
this.change_view_mode(t.value);
```

This:
1. Allows `gantt_start` and `gantt_end` to be recalculated for the new view scale
2. Disables `maintain_scroll`, falling back to `options.scroll_to` behavior (defaults to 'today')

---

## Implementation

### Files Modified

| File | Change | Line |
|------|--------|------|
| `resource/frappe-gantt.es.js` | Remove `!0` argument | ~1077 |
| `resource/frappe-gantt.umd.js` | Remove `!0` argument | minified line |
| `plugin.json` | Version 0.4.0 â†’ 0.4.1 | 6 |

### Commit
```
2193eab bugfix(v0.4.1): Fix view transitions and scroll position
```

---

## Feature Status

| Bug | Status | Notes |
|-----|--------|-------|
| Data fails to populate | ðŸ”„ Partial | maintain_scroll fixed, but SVG width issue found |
| Scroll position jumps | âœ… Fixed | Now scrolls to Today on view change |
| SVG width 100% issue | ðŸ”´ NEW | Causes partial render from Hour view |

---

## ðŸ”´ NEW ISSUE FOUND IN QA (2025-12-22)

### Bug 3: SVG Width 100% Causes Partial Render

**Symptom:** When transitioning FROM Hour view UP to other views (Quarter Day, Half Day, Day, Month), only a partial chart renders.

**QA Observation:**
```
width=100%           â†’ Partial render (BROKEN)
width=20250px        â†’ Full render (WORKS)
```

**Root Cause Analysis:**

In `frappe-gantt.es.js`:

1. **`make_grid_background()` (line 1033-1036):**
   ```javascript
   p.attr(this.$svg, {
     height: e,
     width: "100%"  // Sets width to 100% - PROBLEM
   })
   ```

2. **`set_dimensions()` (line 1321-1324):**
   ```javascript
   set_dimensions() {
     const { width: t } = this.$svg.getBoundingClientRect();
     const e = this.$svg.querySelector(".grid .grid-row").getAttribute("width");
     t < e && this.$svg.setAttribute("width", e);  // Only sets pixels IF container smaller
   }
   ```

**The Problem:**
- `make_grid_background()` sets SVG to `width: 100%`
- `set_dimensions()` only overrides to pixels IF `getBoundingClientRect().width < grid-row width`
- When container is already wide (e.g., from previous Hour view), the condition `t < e` fails
- SVG stays at `100%` which causes rendering issues with bar positioning

**Proposed Fix Options:**

**Option A:** Always set pixel width in `set_dimensions()`:
```javascript
set_dimensions() {
  const e = this.$svg.querySelector(".grid .grid-row") ?
            this.$svg.querySelector(".grid .grid-row").getAttribute("width") : 0;
  if (e) this.$svg.setAttribute("width", e);  // Always set pixel width
}
```

**Option B:** Calculate pixel width in `make_grid_background()`:
```javascript
const width = this.dates.length * this.config.column_width;
p.attr(this.$svg, {
  height: e,
  width: width  // Use calculated pixel width, not 100%
});
```

---

## QA Checklist (Pending User Verification)

### v0.4.1 Bug Fixes
- [ ] Load chart with tasks
- [ ] Switch Week â†’ Month: bars visible, scrolls to Today
- [ ] Switch Month â†’ Year: bars visible, scrolls to Today
- [ ] Switch Week â†’ Day â†’ Half Day â†’ Quarter Day â†’ Hour: data visible at each step
- [ ] Switch Hour â†’ Quarter Day â†’ Half Day â†’ Day: data visible (was broken before)
- [ ] "Today" button works in all views

### v0.4.0 Regression Checks (Must Still Work)

#### Responsive Header Abbreviations
| View | Test | Expected |
|------|------|----------|
| Week | Column width >= 50 | Shows "11 - 17" (day range) |
| Week | Column width < 50 | Shows "11" (single day) |
| Month | Column width >= 75 | Shows "January" |
| Month | Column width >= 39 | Shows "Jan" |
| Month | Column width < 39 | Shows "J" |
| Year | Column width >= 34 | Shows "2024" |
| Year | Column width < 34 | Shows "24" |

#### Date Boundary Controls
- [ ] Set Fixed Start Date (e.g., 2024-06-01) â†’ chart starts at that date
- [ ] Set Fixed End Date (e.g., 2024-12-31) â†’ chart ends at that date
- [ ] **Switch view modes with boundaries set** â†’ boundaries still respected
- [ ] Clear both dates â†’ chart returns to automatic date calculation
- [ ] Set Start >= End â†’ error message displayed, chart blocked

#### Frappe Stability
- [ ] No clientWidth errors in console on view mode switch
- [ ] No JavaScript errors during any view transition

---

## Technical Discovery

**Frappe Gantt `maintain_scroll` behavior:**
- Intended for programmatic view changes where you want to preserve position
- NOT suitable for user-initiated view mode switches from dropdown
- Pixel-based scroll preservation doesn't translate between views with different column widths

**Lesson Learned:** The `maintain_scroll` parameter is a convenience feature that only works when the time scale is similar. For drastic view mode changes (Hour â†” Year), it causes more problems than it solves.

---

## Deferred Items

### Configuration Input Debouncing
**Target:** v0.4.2
**Description:**
The Dataiku webapp framework sends configuration updates immediately on every change event. For inputs like "Bar Height" (numeric spinner), this causes the chart to re-render for every single step (e.g., 30 -> 31 -> 32 -> 33), causing "jank" and scroll jumps.

**Proposed Solution:**
Implement a 500ms debounce timer in `app.js` inside the `message` event listener. This will ensure the chart only re-renders once the user stops interacting with the input controls.

**Status:** Identified during v0.4.1 analysis, deferred to next release to minimize scope creep for hotfix.

### Persist View Mode State
**Target:** v0.4.2
**Description:**
Currently, refreshing the page or navigating away resets the view mode to the default (typically "Week"). If a user is working in "Day" view, they lose this context every time they reload, which is frustrating.

**Proposed Solution:**
Save the selected view mode (and potentially scroll position) to `localStorage` or a user preference object when it changes. On application load, check for this saved value and restore it. If no value exists, fallback to the configured system default or a "smart default" based on project duration.

**Status:** Identified as a usability gap during v0.4.1 QA.

---

## Related Documents

- Spec: `plan/specs/bugfix-v0.4.1-spec.md`
- Deferred from: v0.4.0 (see `plan/interventions/v0.4.0-intervention.md`)