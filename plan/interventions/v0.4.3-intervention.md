# v0.4.3 Intervention: Header Enhancements & View Persistence

## Branch
`feature/v0.4.3-header-enhancements-clean`

## Status
**Phase:** Ready for Implementation

---

## Reference
See `v0.4.3-abandoned-reference.md` for complete implementation code snippets (proven working).

---

## Scope

| Issue | Title | Priority | Status |
|-------|-------|----------|--------|
| #16 | Persist view mode | medium | Ready |
| #13 | Month letter visibility | low | Ready |
| #12 | Year in upper headers | low | Ready |
| #14 | Decade format | low | **DEFERRED** |

**Why #14 Deferred:** Caused instability affecting other views during prior attempt. Not worth the risk for a low-priority feature.

---

## Implementation Order

1. **#16 (Persistence)** - Foundation, test thoroughly before proceeding
2. **#13 (Month letters)** - Single line change
3. **#12 (Year context)** - New helper function
4. **Version bump** - 0.4.2 → 0.4.3
5. **QA Gate** - User testing
6. **Commit and PR**

---

## Implementation Checklist

### #16: View Mode Persistence
**Location:** `webapps/gantt-chart/app.js` - Add after STATE section (~line 62)

- [ ] Add `VALID_VIEW_MODES` constant
- [ ] Add `hashString()` function (djb2 algorithm)
- [ ] Add `getViewModeStorageKey()` function
- [ ] Add `loadPersistedViewMode()` with self-healing validation
- [ ] Add `saveViewMode()` function
- [ ] Modify `buildGanttConfig()` to load persisted mode
- [ ] Modify `on_view_change` to save `mode.name` (NOT mode object!)
- [ ] TEST: Change view → refresh → verify persistence

### #13: Month Single-Letter
**Location:** `adjustHeaderLabels()` (~line 205)

- [ ] Change: `if (columnWidth < 30)` → `if (columnWidth < 30 && viewMode !== 'Month')`
- [ ] TEST: Month view at narrow width shows all 12 letters

### #12: Year Context
**Location:** After `formatWeekLabels()` (~line 246)

- [ ] Add `formatUpperMonthsWithYear()` helper (uses `ganttInstance.gantt_start`)
- [ ] Add `formatDayLabels()` that calls helper
- [ ] Update `formatWeekLabels()` to also call helper
- [ ] Add 'Day' case to switch in `adjustHeaderLabels()`
- [ ] TEST: Day/Week views show year on first month of each year

### Final Steps
- [ ] Version bump `plugin.json` to 0.4.3
- [ ] QA round (no debug logging!)
- [ ] Commit with conventional commit message
- [ ] Update CLAUDE.md Session State

---

## Key Implementation Code

All code snippets are in `v0.4.3-abandoned-reference.md`. Key sections:

1. **Hash function and persistence** - Lines 101-160
2. **Month view exception** - Lines 24-33
3. **Year context helper** - Lines 43-87

### Critical Gotcha
```javascript
// on_view_change: mode is OBJECT, not string!
on_view_change: function(mode) {
    const viewModeName = typeof mode === 'string' ? mode : mode.name;
    saveViewMode(webAppConfig.dataset, viewModeName);
}
```

---

## Files to Modify

| File | Changes |
|------|---------|
| `webapps/gantt-chart/app.js` | #16, #13, #12 implementations |
| `plugin.json` | Version bump |

---

## QA Script for User

```
1. VIEW MODE PERSISTENCE (#16)
   - Change view mode to Month
   - Refresh the page (F5)
   - EXPECTED: View mode stays at Month
   - Optional: DevTools → Application → Local Storage
   - EXPECTED: Key is "gantt-vm-{hash}" (no dataset name visible)

2. MONTH ABBREVIATION (#13)
   - Switch to Month view
   - Set Column Width to 25px (narrow)
   - EXPECTED: All 12 month letters visible (J, F, M, A, M, J, J, A, S, O, N, D)
   - No labels should be skipped

3. YEAR CONTEXT (#12)
   - Switch to Day view
   - EXPECTED: Upper headers show "Dec 2024" on first month of each year
   - Switch to Week view
   - EXPECTED: Same behavior - year shown on first month only

4. REGRESSION CHECK
   - Verify sticky header works
   - Verify Today button works
   - Switch between all view modes
   - EXPECTED: No errors, smooth transitions
```
