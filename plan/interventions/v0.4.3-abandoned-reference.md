# v0.4.3 Intervention: Header Enhancements & View Persistence

## Branch
`feature/v0.4.3-header-enhancements`

## Final Status
**Phase:** ABANDONED - Branch untrusted, clean re-implementation required

---

## Executive Summary

This branch became compromised through excessive debugging iterations on #14 (decade format). The debugging process introduced instability affecting other views. Decision: Document learnings, revert to clean state, re-implement only proven features.

---

## What Worked (Re-implement These)

### #13: Month Single-Letter Abbreviations - PASSED QA
**Problem:** At narrow column widths (<30px), every other month label was being skipped. With single-letter abbreviations, all 12 should fit.

**Solution:** Add exception for Month view in the label-skipping logic.

**Implementation (SIMPLE - one line change):**
```javascript
// In adjustHeaderLabels(), change:
if (columnWidth < 30) {
// To:
if (columnWidth < 30 && viewMode !== 'Month') {
```

**Location:** `adjustHeaderLabels()` function, around line 205

**Why it works:** Month view uses single-letter abbreviations (J, F, M, A, M, J, J, A, S, O, N, D) which are narrow enough to display all 12 without skipping.

---

### #12: Year Context in Day/Week Upper Headers - PASSED QA
**Problem:** In Day and Week views, upper headers show month names without year, making it hard to identify year boundaries.

**Solution:** Show year on first month of each year only (like "Dec 2024", then "Jan", "Feb"...)

**Implementation:**
1. Create helper function `formatUpperMonthsWithYear()`
2. Create `formatDayLabels()` that calls the helper
3. Update `formatWeekLabels()` to also call the helper
4. Add 'Day' case to switch statement

**Key code for helper:**
```javascript
function formatUpperMonthsWithYear() {
    const upperTexts = document.querySelectorAll('.upper-text');

    // Get starting year from gantt instance
    let currentYear = ganttInstance?.gantt_start?.getFullYear() ?? new Date().getFullYear();
    let lastMonthIndex = ganttInstance?.gantt_start?.getMonth() ?? 0;
    const seenYears = new Set();

    upperTexts.forEach(text => {
        const original = text.textContent.trim();
        if (!original) return;

        // Find month index from text
        let monthIndex = findMonthIndex(original); // helper to match month names
        if (monthIndex === -1) return;

        // Detect year transition (month went backwards = new year)
        if (monthIndex < lastMonthIndex) {
            currentYear++;
        }
        lastMonthIndex = monthIndex;

        // Show year on first month of each year, short month otherwise
        if (!seenYears.has(currentYear)) {
            seenYears.add(currentYear);
            text.textContent = `${MONTH_NAMES_3[monthIndex]} ${currentYear}`;
        } else {
            text.textContent = MONTH_NAMES_3[monthIndex];
        }
    });
}
```

**Consistent labeling rule (user requirement):**
- Month + Year: "Jan 2024" (3-letter month)
- Month only: "Jan" (3-letter month)

---

### #16: View Mode Persistence - PASSED QA (after fix)
**Problem:** User changes view mode, refreshes page, view resets to default.

**Solution:** localStorage with hashed dataset key for security.

**Implementation:**
1. Add hash function for key security
2. Add load/save functions with validation
3. Load persisted mode in `buildGanttConfig()`
4. Save mode in `on_view_change` callback

**Key code:**
```javascript
// Hash function (djb2 algorithm)
function hashString(str) {
    let hash = 5381;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash) ^ str.charCodeAt(i);
    }
    return (hash >>> 0).toString(16);
}

function getViewModeStorageKey(datasetName) {
    return `gantt-vm-${hashString(datasetName || 'default')}`;
}

// Valid view modes for validation
const VALID_VIEW_MODES = ['Hour', 'Quarter Day', 'Half Day', 'Day', 'Week', 'Month', 'Year'];

// Self-healing load
function loadPersistedViewMode(datasetName) {
    try {
        const key = getViewModeStorageKey(datasetName);
        const saved = localStorage.getItem(key);
        if (!saved) return null;
        if (VALID_VIEW_MODES.includes(saved)) {
            return saved;
        }
        // Invalid - remove and return null (self-healing)
        localStorage.removeItem(key);
        return null;
    } catch (e) {
        return null;
    }
}

// Save function
function saveViewMode(datasetName, viewMode) {
    try {
        const key = getViewModeStorageKey(datasetName);
        localStorage.setItem(key, viewMode);
    } catch (e) {
        console.warn('Failed to save view mode:', e);
    }
}
```

**CRITICAL BUG DISCOVERED:** In `on_view_change`, the `mode` parameter is an OBJECT `{name: "Week", padding: "2m", ...}`, not a string. Must use `mode.name`:
```javascript
on_view_change: function(mode) {
    const viewModeName = typeof mode === 'string' ? mode : mode.name;
    saveViewMode(webAppConfig.dataset, viewModeName);
    // ...
}
```

**In buildGanttConfig:**
```javascript
const persistedViewMode = loadPersistedViewMode(webAppConfig.dataset);
const effectiveViewMode = persistedViewMode || webAppConfig.viewMode || 'Week';
```

---

## What Failed

### #14: Decade Format in Year View - ABANDONED
**Problem:** Show "2020s" instead of individual years in upper headers for Year view.

**Why it failed:**
1. Frappe-gantt's Year view upper-text elements contain decade START years (1990, 2000, 2010, 2020...)
2. Our code correctly identified and reformatted them to "1990s", "2000s", etc.
3. Console logging proved the values were being set correctly
4. BUT the visual display had issues - "2020s" appeared in wrong position or not at all
5. Further investigation revealed chart is in an iframe, making DOM debugging from parent console impossible
6. Attempting to fix caused UI issues in OTHER views
7. After 3+ QA rounds and extensive debugging, feature became liability

**Technical issues encountered:**
- DOM elements exist inside iframe, not queryable from parent console
- Possible timing issue where frappe-gantt redraws after our formatting
- Adding decade logic may have interfered with other view modes' label processing
- Debug logging added significant code noise

**Decision:** Feature is low priority and not worth the risk. Abandon entirely.

---

## QA History

### Round 1 - BLOCKED
- **Error:** `TypeError: can't access property "name", t is undefined`
- **Cause:** Invalid view mode in localStorage crashed frappe-gantt
- **Fix:** Added VALID_VIEW_MODES validation array

### Round 2 - PARTIAL
| Feature | Result |
|---------|--------|
| #14 Decade | PARTIAL - decades show but "2020s" missing |
| #13 Month letters | PASS |
| #12 Year context | PASS |
| #16 Persistence | FAIL - not persisting |

- **#16 Root cause:** Saving `mode` object instead of `mode.name` string
- **User feedback:** Requested consistent 3-letter month names in upper text

### Round 3 - ISSUES
- Added extensive debug logging
- Fixed #16 by extracting `mode.name`
- #14 still problematic - console shows values set but visual display wrong
- User reported "weird UI issues" on other views
- **Decision:** Abandon branch, re-implement cleanly

---

## Commits on This Branch (All to be Reverted)

1. `ecc8f6a` - Initial implementation (all 4 features)
2. `7b4e424` - Validate persisted view mode
3. `7686344` - Self-healing localStorage
4. `96ba255` - Consistent month names + debug logging
5. `f03d4fe` - Extract mode.name + more debug
6. `b9a2210` - Verify readback debug

---

## Clean Re-implementation Plan

### Step 1: Reset Branch
```bash
git reset --hard <commit-before-v0.4.3-work>
# or
git checkout main -- webapps/gantt-chart/app.js plugin.json
```

### Step 2: Implement #16 (Persistence) FIRST
- Add hash functions and VALID_VIEW_MODES at top of file
- Add load/save functions
- Modify buildGanttConfig to load persisted mode
- Modify on_view_change to save mode.name (NOT mode object!)
- Test thoroughly before proceeding

### Step 3: Implement #13 (Month Letters)
- Single line change in adjustHeaderLabels
- Add `&& viewMode !== 'Month'` to skip condition

### Step 4: Implement #12 (Year Context)
- Add formatUpperMonthsWithYear helper
- Add formatDayLabels function
- Update formatWeekLabels to call helper
- Add 'Day' case to switch

### Step 5: DO NOT IMPLEMENT #14
- Leave Year view formatting as-is
- Document in release notes as "not included in this release"

### Step 6: Version Bump and QA
- Change version to 0.4.3
- Single QA round for 3 features
- No debug logging in final code

---

## Files to Modify (Clean Implementation)

| File | Changes |
|------|---------|
| `webapps/gantt-chart/app.js` | #16 persistence, #13 month skip, #12 year context |
| `plugin.json` | Version 0.4.2 â†’ 0.4.3 |

---

## Lessons Learned

1. **Don't debug in production code** - Debug logging should be temporary and removed immediately
2. **Test features in isolation** - #14 should have been tested alone before combining with others
3. **Trust QA failures** - When something doesn't work after 2 rounds, consider abandoning
4. **iframe context matters** - Can't debug DOM from parent console
5. **frappe-gantt mode object** - on_view_change passes object, not string
6. **Low priority = expendable** - Don't spend hours on low-priority features

---

## Context Recovery

If resuming after compaction:
1. This branch is UNTRUSTED - do not continue from current state
2. Reset to clean state and re-implement using the code snippets above
3. Only implement #13, #12, #16 - skip #14 entirely
4. No debug logging in final implementation
