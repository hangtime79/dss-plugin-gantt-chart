# Intervention Log: v0.7.1 Sticky Header Fix

**Branch:** `bugfix/v0.7.1-sticky-header-narrow-content`
**Started:** 2025-12-26
**Status:** ðŸ”„ IN QA - Round 9

---

## Issue

**#21:** Sticky header janky when chart content narrower than viewport

When SVG content doesn't fill the container width (e.g., Year view with short date range), the sticky header becomes choppy during vertical scroll due to browser paint/composite behavior.

---

## Current Solution (v8)

### Core Logic
After each render, check if SVG is narrower than container. If so:
1. Calculate minimum column width: `minColWidth = currentColWidth Ã— (containerWidth / svgWidth) Ã— 1.02`
2. Apply as new column width
3. Re-render with `change_view_mode()`
4. Guard prevents infinite loop via `edgeToEdgeInProgress` flag

### Key Code Location
**File:** `webapps/gantt-chart/app.js` lines 852-921

```javascript
// Guard to prevent re-render loop
let edgeToEdgeInProgress = false;

function ensureEdgeToEdgeContent() {
    if (!ganttInstance) return;
    if (edgeToEdgeInProgress) return;  // CRITICAL: prevents infinite loop

    // ... calculate minColumnWidthForViewport ...

    if (currentColWidth < minColumnWidthForViewport) {
        currentColumnWidth = minColumnWidthForViewport;
        ganttInstance.options.column_width = minColumnWidthForViewport;
        updateZoomIndicator();

        // Re-render with guard
        edgeToEdgeInProgress = true;
        ganttInstance.change_view_mode(ganttInstance.options.view_mode);
        // Clear guard after 2 frames (covers callback cycle)
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                edgeToEdgeInProgress = false;
            });
        });
    }
}
```

### Where It's Called
1. **Initial render:** `renderGantt()` post-render block (line 739)
2. **View mode change:** `on_view_change` callback (line 697)

### Zoom Floor Enforcement
In `adjustZoom()` (line ~1280):
```javascript
const effectiveMinZoom = Math.max(MIN_ZOOM, minColumnWidthForViewport);
```

---

## What Works (Confirmed)
- âœ… Smooth scrolling in all view modes (main fix)
- âœ… View mode transitions work (no infinite loops)
- âœ… Edge-to-edge content fills viewport

## What's Being Tested (v9)
- Manual zoom not capped (regression fix from v8)
- Year view auto-zooms to fill viewport
- Month â†” Year transitions work
- Zoom indicator updates

## Known Limitations (Accepted)
- High zoom from Year carries over when switching to Month (not auto-resetting)
- Label bleeding at extreme zoom levels (separate issue)
- Config panel columnWidth not synced (Dataiku limitation)

---

## Files Modified

| File | Changes |
|------|---------|
| `webapps/gantt-chart/app.js` | Added `ensureEdgeToEdgeContent()`, `minColumnWidthForViewport`, guard logic |
| `plugin.json` | Version 0.7.0 â†’ 0.7.1 |

---

## Commit History

| Hash | Description |
|------|-------------|
| `36bf36d` | v9 - Removed minColumnWidthForViewport floor from adjustZoom |
| `b5f919a` | v8 - Fixed guard timing with double rAF |
| `27e0b4d` | v7 - Simplified, removed view mode manipulation (broke Year) |
| `a098530` | v6 - Added view mode passing (caused infinite loops) |
| `d0e5372` | v5 - Added localStorage caching |
| `5d2534d` | v4 - Added view mode reset |
| `3467f69` | v3 - Basic minimum floor |

---

## Recovery After Context Compaction

1. **Read this file first**
2. **Check current state:**
   ```bash
   git log --oneline -1
   git status
   ```
3. **Key file:** `webapps/gantt-chart/app.js` lines 852-921
4. **Await user QA feedback for v8**
5. **If QA passes:** Run branch-exit-protocol for merge/release

## If QA Fails

Common issues and fixes:
- **Infinite loop on view change:** Check `edgeToEdgeInProgress` guard
- **Year view not filling:** Ensure `ensureEdgeToEdgeContent()` called in `on_view_change`
- **Zoom indicator wrong:** Ensure `updateZoomIndicator()` called after setting `currentColumnWidth`
