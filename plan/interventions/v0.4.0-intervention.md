# Intervention Log: v0.4.0 View Enhancements

**Branch:** `feature/v0.4.0-view-enhancements`
**Started:** 2025-12-21
**Status:** In Progress

---

## Implementation Plan (TODOs)

### Feature 1: Fix Header Text Collisions (CSS Overflow)
- [x] Add `.upper-text` max-width constraint
- [x] Add `.upper-text` overflow: hidden, text-overflow: ellipsis
- [x] Add `.lower-text` overflow handling
- [x] Add narrow view font size adjustment
- [x] Add JS label adjustment for very narrow views

### Feature 1b: Responsive Header Abbreviations
Implement responsive label formatting based on column width. Requires JS to intercept label rendering.

#### Configuration
- [x] Update webapp.json: Increase `columnWidth` minI from 20 to 25

#### No changes needed for:
- Hour view
- Quarter Day view
- Half Day view
- Day view

#### Week Mode Labels
| Column Width | Format | Example |
|--------------|--------|---------|
| >= 50 | Day range (no months) | "03 - 10", "31 - 06" |
| < 50 | First day only | "01", "02", "25", "30" |

- [x] Implement Week mode responsive formatting (>= 50: range, < 50: single day)

#### Month Mode Labels
| Column Width | Format | Example |
|--------------|--------|---------|
| >= 72 | Full month | "January", "February" |
| >= 39 | 3-letter | "Jan", "Feb" |
| < 39 | 1-letter | "J", "F", "M" |

- [x] Implement Month mode responsive formatting (full ‚Üí 3-letter ‚Üí 1-letter)

#### Year Mode Labels
| Column Width | Format | Example |
|--------------|--------|---------|
| >= 34 | Full year | "2024", "2025" |
| < 34 | 2-digit | "24", "25" |

- [x] Implement Year mode responsive formatting (YYYY ‚Üí YY)

#### Implementation Approach
- [x] No hooks available: implemented post-render DOM manipulation
- [x] Ensure formatting updates on view mode change (via on_view_change callback)
- [x] Ensure formatting updates on column width change (via adjustHeaderLabels())

### Feature 2: Sticky Header Fix (CSS-only approach - NOT WORKING)
- [x] Reinforce `.grid-header` sticky positioning in custom CSS
- [x] Ensure proper z-index stacking
- [x] Background color for header to prevent content showing through

### Feature 2b: Sticky Header - Root Cause Analysis & Fix

#### Investigation Findings

**The Problem: Nested Scroll Containers**

Container structure:
```
#gantt-container          (overflow: auto, height: 100%) ‚Üê USER SCROLLS HERE
  ‚îî‚îÄ‚îÄ .gantt-container    (overflow: auto, height: var(--gv-grid-height)) ‚Üê Frappe's
        ‚îú‚îÄ‚îÄ .grid-header  (position: sticky, top: 0) ‚Üê RELATIVE TO WRONG CONTAINER
        ‚îî‚îÄ‚îÄ svg.gantt
```

- `position: sticky` is relative to the **nearest scrolling ancestor**
- The header is sticky relative to `.gantt-container` (Frappe's inner container)
- But `.gantt-container` doesn't actually scroll (its height matches content)
- User scrolls `#gantt-container` (our outer wrapper)
- Therefore sticky has no effect

**Frappe Gantt CSS (from library):**
```css
.gantt-container {
    overflow: auto;
    height: var(--gv-grid-height);  /* Matches content exactly */
}
.gantt-container .grid-header {
    position: sticky;
    top: 0;
}
```

#### Possible Solutions

**Option A: Override Inner Container Overflow**
- [x] Try: `.gantt-container { overflow-y: visible !important; overflow-x: auto; }`
- [ ] Test: Does sticky now work relative to outer container?
- [ ] Risk: May break horizontal scrolling

**Option B: JavaScript Scroll Sync (Fallback)**
- [ ] Listen to scroll events on `#gantt-container`
- [ ] Apply `transform: translateY(scrollTop)` to `.grid-header`
- [ ] Use `requestAnimationFrame` for smooth performance
- [ ] Handle both initial scroll and dynamic updates

**Option C: Make Inner Container the Scroll Target**
- [ ] Set `#gantt-container { overflow: hidden; }`
- [ ] Override `.gantt-container { height: 100%; }`
- [ ] Risk: Previously documented that overriding height breaks scrolling

**Option D: Clone Header Outside Scroll Container**
- [ ] Create fixed header area outside scroll container
- [ ] Clone header content and keep in sync
- [ ] Most complex but gives full control

#### Implementation TODOs
- [ ] Test Option A first (simplest)
- [ ] If Option A fails: implement Option B (JS scroll sync)
- [ ] Update `adjustHeaderLabels()` to work with new approach
- [ ] Test with 50+ tasks to verify vertical scroll works
- [ ] Test horizontal scroll still works

### Feature 3: Date Boundary Controls
- [x] Add "Date Boundaries" separator to webapp.json
- [x] Add `chartStartDate` parameter (STRING type)
- [x] Add `chartEndDate` parameter (STRING type)
- [x] Implement monkey-patch for `setup_gantt_dates` in app.js
- [x] Add date validation (format check, start < end)
- [x] Add auto-adjustment for start >= end case

### Feature 3b: Date Boundary Enhancements

#### Constrain to Inside Dates
User-specified dates should only NARROW the range, never EXPAND it beyond calculated bounds.
- [x] If user start date < calculated start ‚Üí use calculated start (don't expand left)
- [x] If user end date > calculated end ‚Üí use calculated end (don't expand right)
- [x] Log warning when user date was constrained

#### Input Debouncing (Blur/Enter to Update)
Prevent updates on every keystroke for text/numeric inputs. Only fire update when:
- User presses Enter
- User tabs out / loses focus (blur event)
- User clicks up/down spinner buttons (for numeric fields)

**Note:** Dataiku's standard webapp parameter handling already provides this behavior.
Text inputs debounce automatically and only fire config updates on blur/enter.
No custom JS implementation needed.

- [x] Investigated Dataiku webapp parameter event handling - built-in debouncing exists
- [N/A] Custom JS not needed - Dataiku handles this

#### Start > End Validation UI
- [x] If Fixed Start Date > Fixed End Date: block chart rendering
- [x] Show error message via displayError() - "Fixed Start Date cannot be on or after Fixed End Date"
- [x] Chart does not render until user fixes the dates (return early from event handler)
- [x] Clear error and proceed when dates are valid (normal flow resumes)

### Feature 4: JS Enhancements
- [x] Add `adjustHeaderLabels()` function for narrow views
- [x] Add `applyDateBoundaryPatch()` function
- [x] Update `on_view_change` callback to call label adjustment
- [x] Ensure all functions run after `requestAnimationFrame`

### Finalization
- [x] Version bump plugin.json: 0.3.0 ‚Üí 0.4.0
- [x] Commit all changes (86575a8)
- [x] Notify user for QA testing

---

## Feature Status

| # | Feature | Status | Notes |
|---|---------|--------|-------|
| 1 | Fix Header Text Collisions (CSS) | ‚úÖ Complete | CSS overflow handling in style.css |
| 1b | Responsive Header Abbreviations | üîß Bug Fixed | Week/Month/Year - fixed config‚Üíoptions access |
| 2 | Sticky Header Fix (CSS-only) | ‚ùå Not Working | Nested scroll container issue |
| 2b | Sticky Header Fix (Option A) | üîÑ Testing | overflow-y: visible applied, needs QA |
| 3 | Date Boundary Controls | ‚úÖ Complete | webapp.json + app.js monkey-patch |
| 3b | Date Boundary Enhancements | ‚úÖ Complete | Inside constraint + validation UI |
| 4 | JS Enhancements | ‚úÖ Complete | adjustHeaderLabels() + applyDateBoundaryPatch() |
| 5 | Version Bump | ‚úÖ Complete | 0.3.0 ‚Üí 0.4.0 |

---

## Session Log

### 2025-12-21 - Initial Implementation

#### Step 1: CSS Fixes for Header Collisions and Sticky Header

**File:** `resource/webapp/style.css`

**Planned Changes:**
```css
/* Header text collision fix */
.gantt-container .upper-text {
    max-width: calc(var(--gv-column-width, 45px) * 4);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.gantt-container .lower-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Sticky header reinforcement */
.gantt-container .grid-header {
    position: sticky;
    top: 0;
    z-index: 1001;
    background-color: var(--g-header-background, #fff);
}
```

**Rationale:**
- `.upper-text` in Frappe Gantt uses `width: fit-content` which allows text to extend indefinitely
- No overflow handling causes "December 2024" to overlap adjacent month labels
- Narrow views (Hour, Quarter Day) have small column widths where text doesn't fit

**Status:** Pending edit approval

---

## Files Modified

| File | Status | Description |
|------|--------|-------------|
| `resource/webapp/style.css` | ‚úÖ Complete | Header collision + sticky fixes |
| `webapps/gantt-chart/webapp.json` | üîÑ Needs Update | Date boundary params (done), minI change (pending) |
| `webapps/gantt-chart/app.js` | üîÑ Needs Update | Date constraints (done), responsive abbreviations (pending) |
| `plugin.json` | ‚úÖ Complete | Version bump to 0.4.0 |
| `plan/specs/feature-v0.4.0-spec.md` | ‚úÖ Created | Feature specification |

---

## Issues Encountered

### Issue: Feature 1b Not Working - Wrong Property Access

**Date:** 2025-12-22

**Symptom:** Responsive header abbreviations not changing despite implementation being complete.

**Root Cause:** In `adjustHeaderLabels()` lines 171-172, accessing `ganttInstance.config` instead of `ganttInstance.options`.

Frappe Gantt stores:
- `options.view_mode` ‚Üí String ("Week", "Month", "Year")
- `config.view_mode` ‚Üí Object ({ name: "Week", step: 7, ... })

The switch statement compared an object to strings, so no case ever matched.

**Fix:** Change `ganttInstance.config` to `ganttInstance.options` for both `column_width` and `view_mode`.

**Lesson Learned:** Frappe Gantt's `options` = primitives (user config), `config` = computed objects (internal state). Always use `options` for reading user-specified settings.

---

## Testing Notes

### Pre-QA Checklist
- [ ] Header labels don't overlap in any view mode
- [ ] Header stays fixed during vertical scroll
- [ ] Date boundaries work when set
- [ ] Date boundaries revert to auto when cleared
- [ ] Invalid dates handled gracefully
- [ ] View mode switching works correctly

---

## Rollback Commands

```bash
git checkout main -- resource/webapp/style.css
git checkout main -- webapps/gantt-chart/webapp.json
git checkout main -- webapps/gantt-chart/app.js
git checkout main -- plugin.json
```
