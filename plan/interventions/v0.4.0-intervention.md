# Intervention Log: v0.4.0 View Enhancements

**Branch:** `feature/v0.4.0-view-enhancements`
**Started:** 2025-12-21
**Completed:** 2025-12-22
**Status:** Complete (QA Passed)

---

## Implementation Plan (TODOs)

### Feature 1: Fix Header Text Collisions (CSS Overflow)
- [x] Add `.upper-text` max-width constraint
- [x] Add `.upper-text` overflow: hidden, text-overflow: ellipsis
- [x] Add `.lower-text` overflow handling
- [x] Add narrow view font size adjustment
- [x] Add JS label adjustment for very narrow views

### Feature 1b: Responsive Header Abbreviations
Implement responsive label formatting based on column width. Requires JS to intercept label rendering.

#### Configuration
- [x] Update webapp.json: Increase `columnWidth` minI from 20 to 25

#### No changes needed for:
- Hour view
- Quarter Day view
- Half Day view
- Day view

#### Week Mode Labels
| Column Width | Format | Example |
|--------------|--------|---------|
| >= 50 | Day range (no months) | "03 - 10", "31 - 06" |
| < 50 | First day only | "01", "02", "25", "30" |

- [x] Implement Week mode responsive formatting (>= 50: range, < 50: single day)

#### Month Mode Labels
| Column Width | Format | Example |
|--------------|--------|---------|
| >= 72 | Full month | "January", "February" |
| >= 39 | 3-letter | "Jan", "Feb" |
| < 39 | 1-letter | "J", "F", "M" |

- [x] Implement Month mode responsive formatting (full â†’ 3-letter â†’ 1-letter)

#### Year Mode Labels
| Column Width | Format | Example |
|--------------|--------|---------|
| >= 34 | Full year | "2024", "2025" |
| < 34 | 2-digit | "24", "25" |

- [x] Implement Year mode responsive formatting (YYYY â†’ YY)

#### Implementation Approach
- [x] No hooks available: implemented post-render DOM manipulation
- [x] Ensure formatting updates on view mode change (via on_view_change callback)
- [x] Ensure formatting updates on column width change (via adjustHeaderLabels())

### Feature 2: Sticky Header Fix (CSS-only approach - NOT WORKING)
- [x] Reinforce `.grid-header` sticky positioning in custom CSS
- [x] Ensure proper z-index stacking
- [x] Background color for header to prevent content showing through

### Feature 2b: Sticky Header - Root Cause Analysis & Fix

#### Investigation Findings

**The Problem: Nested Scroll Containers**

Container structure:
```
#gantt-container          (overflow: auto, height: 100%) â† USER SCROLLS HERE
  â””â”€â”€ .gantt-container    (overflow: auto, height: var(--gv-grid-height)) â† Frappe's
        â”œâ”€â”€ .grid-header  (position: sticky, top: 0) â† RELATIVE TO WRONG CONTAINER
        â””â”€â”€ svg.gantt
```

- `position: sticky` is relative to the **nearest scrolling ancestor**
- The header is sticky relative to `.gantt-container` (Frappe's inner container)
- But `.gantt-container` doesn't actually scroll (its height matches content)
- User scrolls `#gantt-container` (our outer wrapper)
- Therefore sticky has no effect

**Frappe Gantt CSS (from library):**
```css
.gantt-container {
    overflow: auto;
    height: var(--gv-grid-height);  /* Matches content exactly */
}
.gantt-container .grid-header {
    position: sticky;
    top: 0;
}
```

#### Possible Solutions

**Option A: Override Inner Container Overflow**
- [x] Try: `.gantt-container { overflow-y: visible !important; overflow-x: auto; }`
- [ ] Test: Does sticky now work relative to outer container?
- [ ] Risk: May break horizontal scrolling

**Option B: JavaScript Scroll Sync (Fallback)**
- [ ] Listen to scroll events on `#gantt-container`
- [ ] Apply `transform: translateY(scrollTop)` to `.grid-header`
- [ ] Use `requestAnimationFrame` for smooth performance
- [ ] Handle both initial scroll and dynamic updates

**Option C: Make Inner Container the Scroll Target**
- [ ] Set `#gantt-container { overflow: hidden; }`
- [ ] Override `.gantt-container { height: 100%; }`
- [ ] Risk: Previously documented that overriding height breaks scrolling

**Option D: Clone Header Outside Scroll Container**
- [ ] Create fixed header area outside scroll container
- [ ] Clone header content and keep in sync
- [ ] Most complex but gives full control

#### Implementation TODOs
- [ ] Test Option A first (simplest)
- [ ] If Option A fails: implement Option B (JS scroll sync)
- [ ] Update `adjustHeaderLabels()` to work with new approach
- [ ] Test with 50+ tasks to verify vertical scroll works
- [ ] Test horizontal scroll still works

### Feature 3: Date Boundary Controls
- [x] Add "Date Boundaries" separator to webapp.json
- [x] Add `chartStartDate` parameter (STRING type)
- [x] Add `chartEndDate` parameter (STRING type)
- [x] Implement monkey-patch for `setup_gantt_dates` in app.js
- [x] Add date validation (format check, start < end)
- [x] Add auto-adjustment for start >= end case

### Feature 3b: Date Boundary Enhancements

#### Constrain to Inside Dates
User-specified dates should only NARROW the range, never EXPAND it beyond calculated bounds.
- [x] If user start date < calculated start â†’ use calculated start (don't expand left)
- [x] If user end date > calculated end â†’ use calculated end (don't expand right)
- [x] Log warning when user date was constrained

#### Input Debouncing (Blur/Enter to Update)
Prevent updates on every keystroke for text/numeric inputs. Only fire update when:
- User presses Enter
- User tabs out / loses focus (blur event)
- User clicks up/down spinner buttons (for numeric fields)

**Note:** Dataiku's standard webapp parameter handling already provides this behavior.
Text inputs debounce automatically and only fire config updates on blur/enter.
No custom JS implementation needed.

- [x] Investigated Dataiku webapp parameter event handling - built-in debouncing exists
- [N/A] Custom JS not needed - Dataiku handles this

#### Start > End Validation UI
- [x] If Fixed Start Date > Fixed End Date: block chart rendering
- [x] Show error message via displayError() - "Fixed Start Date cannot be on or after Fixed End Date"
- [x] Chart does not render until user fixes the dates (return early from event handler)
- [x] Clear error and proceed when dates are valid (normal flow resumes)

### Feature 4: JS Enhancements
- [x] Add `adjustHeaderLabels()` function for narrow views
- [x] Add `applyDateBoundaryPatch()` function
- [x] Update `on_view_change` callback to call label adjustment
- [x] Ensure all functions run after `requestAnimationFrame`

### Finalization
- [x] Version bump plugin.json: 0.3.0 â†’ 0.4.0
- [x] Commit all changes (86575a8)
- [x] Notify user for QA testing

---

## Feature Status

| # | Feature | Status | Notes |
|---|---------|--------|-------|
| 1 | Fix Header Text Collisions (CSS) | âœ… Complete | CSS overflow handling in style.css |
| 1b | Responsive Header Abbreviations | âœ… QA Passed | Week/Month/Year all working (commit 6cd755f) |
| 2 | Sticky Header Fix (CSS-only) | âŒ Not Working | Nested scroll container issue |
| 2b | Sticky Header Fix (Option A) | ðŸ”„ Deferred | CSS approach ineffective, needs JS (v0.4.2) |
| 3 | Date Boundary Controls | âœ… Complete | webapp.json + app.js monkey-patch |
| 3b | Date Boundary Enhancements | âœ… Complete | Inside constraint + validation UI |
| 4 | JS Enhancements | âœ… Complete | adjustHeaderLabels() + applyDateBoundaryPatch() |
| 5 | Version Bump | âœ… Complete | 0.3.0 â†’ 0.4.0 |
| 6 | Frappe clientWidth Patch | âœ… QA Passed | Null guards in frappe-gantt.umd.js |

---

## âœ… QA VERIFICATION RESULTS (2025-12-22)

### Core Features - ALL PASSED
- [x] clientWidth error is gone on view mode transitions - **FIXED**
- [x] Week view >= 50 shows "11 - 17" format (no month names) - **FIXED**
- [x] Week view < 50 shows "11" format (single day) - **FIXED**
- [x] Month view >= 75 shows "January" - **FIXED**
- [x] Month view >= 39 shows "Jan" - **FIXED**
- [x] Month view < 39 shows "J" - **FIXED**
- [x] Year view responsive formatting works - **FIXED**
- [ ] Sticky header (Feature 2b) - **DEFERRED TO v0.4.2** (not breaking, needs JS approach)

---

## Deferred Items

### Bugs â†’ v0.4.1
| Bug | Severity | Description |
|-----|----------|-------------|
| Data fails to populate | HIGH | Transitions: Hourâ†’Quarter Day, Quarter Dayâ†’Half Day, Half Dayâ†’Day lose data |
| Today button Month View | MEDIUM | Jumps to first visible date instead of Today |

### Bugs â†’ v0.4.2
| Bug | Severity | Description |
|-----|----------|-------------|
| Cursor on mode switch | LOW | Cursor stays on static pixel location instead of snapping to Today |

### Feature Requests â†’ v0.4.2
| Request | View | Description |
|---------|------|-------------|
| Sticky Header | All | Implement JS scroll sync (Option B) |
| Add Year to upper header | Day | Format: "December 2024" |
| Add Year to upper header | Half Day | Format: "22 Dec 2024" |
| Add Year to upper header | Quarter Day | Format: "DD MMM YY" |
| Add Year to upper header | Hour | Include year in header |
| Add Year to upper header | Week | Show year on January only |
| Show all month letters | Month (< 39) | Don't skip letters - show J F M A M J... |
| Upper elements decade | Year | Always show full decade (2020, 2030, 2040) |

---

## Session Log

### 2025-12-21 - Initial Implementation

#### Step 1: CSS Fixes for Header Collisions and Sticky Header

**File:** `resource/webapp/style.css`

**Planned Changes:**
```css
/* Header text collision fix */
.gantt-container .upper-text {
    max-width: calc(var(--gv-column-width, 45px) * 4);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.gantt-container .lower-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Sticky header reinforcement */
.gantt-container .grid-header {
    position: sticky;
    top: 0;
    z-index: 1001;
    background-color: var(--g-header-background, #fff);
}
```

**Rationale:**
- `.upper-text` in Frappe Gantt uses `width: fit-content` which allows text to extend indefinitely
- No overflow handling causes "December 2024" to overlap adjacent month labels
- Narrow views (Hour, Quarter Day) have small column widths where text doesn't fit

**Status:** Pending edit approval

---

## Files Modified

| File | Status | Description |
|------|--------|-------------|
| `resource/webapp/style.css` | âœ… Complete | Header collision + sticky attempt |
| `resource/frappe-gantt.umd.js` | âœ… Complete | Null guards for clientWidth |
| `resource/frappe-gantt.es.js` | âœ… Complete | Same patches for consistency |
| `webapps/gantt-chart/webapp.json` | âœ… Complete | Date boundary params + minI 20â†’25 |
| `webapps/gantt-chart/app.js` | âœ… Complete | Responsive labels + date constraints |
| `plugin.json` | âœ… Complete | Version bump to 0.4.0 |
| `plan/specs/feature-v0.4.0-spec.md` | âœ… Created | Feature specification |
| `CLAUDE.md` | âœ… Updated | Added gotchas from this session |

---

## Issues Encountered

### Issue: Feature 1b Not Working - Wrong Property Access

**Date:** 2025-12-22

**Symptom:** Responsive header abbreviations not changing despite implementation being complete.

**Root Cause:** In `adjustHeaderLabels()` lines 171-172, accessing `ganttInstance.config` instead of `ganttInstance.options`.

Frappe Gantt stores:
- `options.view_mode` â†’ String ("Week", "Month", "Year")
- `config.view_mode` â†’ Object ({ name: "Week", step: 7, ... })

The switch statement compared an object to strings, so no case ever matched.

**Fix:** Change `ganttInstance.config` to `ganttInstance.options` for both `column_width` and `view_mode`.

**Lesson Learned:** Frappe Gantt's `options` = primitives (user config), `config` = computed objects (internal state). Always use `options` for reading user-specified settings.

### Issue: Month Formatting Targeting Wrong Elements

**Date:** 2025-12-22

**Symptom:** Month view abbreviations not changing at any column width.

**Root Cause:** `formatMonthLabels()` was targeting `.upper-text` elements, but in Month view:
- `.upper-text` = years (2021, 2022, etc.)
- `.lower-text` = months (January, February, etc.)

**Fix:** Changed `formatMonthLabels()` to target `.lower-text` instead.

### Issue: Frappe Gantt clientWidth Error on View Mode Switch

**Date:** 2025-12-22

**Symptom:** `TypeError: can't access property "clientWidth", m is undefined` when switching to Month or Year view.

**Root Cause:** In `frappe-gantt.umd.js`, the scroll handler and `set_scroll_position()` method call:
```javascript
m = this.upperTexts.find(b => b.textContent === $);
// m can be undefined if no matching element found
this.current_date = d.add(..., m.clientWidth, ...); // CRASH
```

When switching view modes, `this.upperTexts` contains stale DOM references, so `.find()` returns `undefined`.

**Fix:** Patched `frappe-gantt.umd.js` to add null guards:
```javascript
m = this.upperTexts.find(b => b.textContent === $);
if (!m) return;  // Added guard
```

**Lesson Learned:** Frappe Gantt has no `destroy()` method - event listeners persist after DOM is cleared. Always guard against undefined when accessing DOM elements that may be stale.

---

## Testing Notes

### Pre-QA Checklist
- [x] Header labels don't overlap in any view mode
- [ ] Header stays fixed during vertical scroll - **DEFERRED (v0.4.2)**
- [x] Date boundaries work when set
- [x] Date boundaries revert to auto when cleared
- [x] Invalid dates handled gracefully
- [x] View mode switching works correctly (clientWidth patched)

### QA Verified (2025-12-22)
All responsive abbreviation thresholds verified by QA:

| View | Threshold | Format | QA Status |
|------|-----------|--------|-----------|
| Week | >= 50 | "11 - 17" (day range, no month) | âœ… PASSED |
| Week | < 50 | "11" (single day) | âœ… PASSED |
| Month | >= 75 | "January" | âœ… PASSED |
| Month | >= 39 | "Jan" | âœ… PASSED |
| Month | < 39 | "J" | âœ… PASSED |
| Year | >= 34 | "2024" | âœ… PASSED |
| Year | < 34 | "24" | âœ… PASSED |

---

## Rollback Commands

```bash
git checkout main -- resource/webapp/style.css
git checkout main -- webapps/gantt-chart/webapp.json
git checkout main -- webapps/gantt-chart/app.js
git checkout main -- plugin.json
```
