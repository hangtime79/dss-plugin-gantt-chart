# Intervention Log: v0.7.0 Expected Progress & Polish

**Branch:** `feature/v0.7.0-expected-progress-and-polish`
**Started:** 2025-12-26
**Status:** ðŸ”„ IN PROGRESS - Awaiting QA Round 4

---

## Issues Being Addressed

| Issue | Title | Status |
|-------|-------|--------|
| #33 | Expected Progress Indicator | ðŸ”„ CSS error fixed, awaiting QA |
| #45 | Bar corner radius default to 10 | âœ… QA Passed |
| #43 | Remove 'Disable all Editing' option | âœ… QA Passed |
| #42 | Weekend highlighting off by default | âœ… QA Passed |
| #38 | Float dependency strings normalization | ðŸ”„ CSS error fixed, awaiting QA |
| #37 | Pandas deprecation warning | âœ… Code correct (no param used) |

---

## Current State

### Commits on Branch
1. `6fbc424` - feat(v0.7.0): add expected progress indicator and polish
2. `79b21b3` - fix(v0.7.0): rename expected_progress to _expected_progress and add debug logging
3. `1a5b501` - fix(v0.7.0): hex-encode IDs for CSS-safe selectors
4. `2d47d21` - fix(v0.7.0): fix expected progress markers and display IDs

### What's Done
- [x] webapp.json: barCornerRadius default 3â†’10, highlightWeekends default trueâ†’false
- [x] webapp.json: Removed readonly option, added showExpectedProgress toggle
- [x] app.js: Hardcoded readonly=true, added marker injection function
- [x] task_transformer.py: Added _calculate_expected_progress(), fixed float normalization
- [x] task_transformer.py: Added _make_css_safe() for CSS-safe IDs (hex-encoding)
- [x] task_transformer.py: Added _display_id and _display_dependencies for tooltips
- [x] app.js: Fixed expected progress marker DOM lookup (data-id on .bar-wrapper)
- [x] app.js: Tooltip uses _display_dependencies for human-readable output
- [x] style.css: Added expected progress marker styling
- [x] Tests: 122 passing (5 expected progress + 5 CSS-safe tests)

### What's Pending
- [ ] QA Round 4: Verify CSS selector error is fixed
- [ ] QA Round 4: Verify expected progress markers appear
- [ ] QA Round 4: Verify tooltips show original IDs and dependencies

---

## QA Round 1 Results

### Passed
- [x] #45 - Bar corners rounded (radius 10)
- [x] #42 - Weekend highlighting OFF by default
- [x] #43 - No "Read-only" option in Behavior

### Failed (Fixed in commit 79b21b3)
- [ ] #33 - Expected progress toggle exists but markers don't show
- [ ] #38 - Float values cause CSS selector error: `.highlight-55.67`

---

## Fix #1: Rename to `_expected_progress`

**Problem:** Frappe-gantt uses task properties for CSS classes. The `expected_progress` float (55.67) became `.highlight-55.67` which is invalid CSS.

**Solution:** Prefix with underscore: `_expected_progress`. Frappe-gantt ignores underscore-prefixed properties.

---

## QA Round 2 Results

**Finding:** CSS selector error still occurred, but from task ID field not expected_progress.
```
Uncaught DOMException: '.highlight-54.8' is not a valid selector
```

The ID column contained decimal floats (54.8) which frappe-gantt used in `.highlight-{id}` selector.

---

## Fix #2: Hex-encode IDs for CSS safety (commit 1a5b501)

**Problem:** Task IDs with periods (e.g., "54.8") cause `.highlight-54.8` which is invalid CSS.

**Solution:** Hex-encode non-alphanumeric characters using `_xHH_` pattern:
- `54.8` â†’ `54_x2e_8` (period = hex 2e)
- `task 1` â†’ `task_x20_1` (space = hex 20)

This is:
- **Deterministic**: same input â†’ same output
- **Collision-free**: `54.8` â†’ `54_x2e_8` vs `54_8` stays `54_8`
- **Reversible**: can decode back if needed

**Debug logging** in console:
- "Adding expected progress markers for X tasks"
- "Tasks with _expected_progress: Y"
- "Found bar wrappers: Z"
- "Expected progress markers added: N"

---

## QA Round 3 Results

**Findings:**
1. Expected progress markers: 0 added (DOM lookup failure)
2. Console: "No taskId for wrapper" x308 times
3. Hex-encoded IDs showing in tooltips (e.g., `54_x2e_8` instead of `54.8`)

**Root Causes:**
1. Wrong DOM lookup: `wrapper.closest('.bar-group')` goes UP tree, but `.bar-group` is a CHILD of `.bar-wrapper`
2. `data-id` is on `.bar-wrapper`, not `.bar-group`
3. No display-friendly ID stored for tooltips

---

## Fix #3: DOM lookup and display IDs (commit 2d47d21)

**Expected progress markers:**
- Get `data-id` directly from `.bar-wrapper` (it has the attribute)
- Get `.bar-group` as child via `wrapper.querySelector('.bar-group')`

**Display IDs:**
- Added `_display_id` with original value before CSS encoding
- Added `_display_dependencies` with original dependency string
- Task name uses `display_id` when no name column configured
- Tooltip uses `_display_dependencies` for human-readable output

---

## QA Round 4 Instructions

```
1. Reload plugin in Dataiku
2. Open browser console (F12)
3. Enable "Show expected progress" toggle
4. Load chart with tasks spanning today
5. Verify:
   - CSS selector error gone?
   - Expected progress markers visible? (red dashed lines on in-progress tasks)
   - Tooltip shows original IDs (e.g., "54.8" not "54_x2e_8")?
   - Tooltip shows original dependencies?
```

---

## Files Modified

| File | Changes |
|------|---------|
| `webapps/gantt-chart/webapp.json` | Config defaults, removed readonly, added showExpectedProgress |
| `webapps/gantt-chart/app.js` | readonly=true, expected progress markers, debug logging |
| `python-lib/ganttchart/task_transformer.py` | _calculate_expected_progress, _expected_progress field, float normalization |
| `python-lib/ganttchart/date_parser.py` | Comment update |
| `resource/webapp/style.css` | Expected progress marker styling |
| `plugin.json` | Version 0.7.0 |
| `tests/python/unit/test_task_transformer.py` | 5 new expected progress tests |

---

## Recovery Notes

If resuming after context clear:
1. Read this file first
2. Branch is `feature/v0.7.0-expected-progress-and-polish`
3. Awaiting QA Round 2 results
4. If markers still don't show, analyze console debug output
5. Key function: `addExpectedProgressMarkers()` in app.js (~line 847)
